# Network Layer & IP 정리

## 개요

- 본 문서는 네트워크 계층(Network Layer)에서 사용되는 IP 주소 체계와 관련 핵심 개념을 정리한 학습 문서입니다.
- IP 주소, Netmask, Gateway를 중심으로 네트워크 식별 방식과 통신 범위를 이해합니다.

---

## Network Layer와 IP

- Network Layer는 서로 다른 네트워크 간 데이터 전달을 담당하는 계층입니다.
- 대표적인 프로토콜은 다음과 같습니다.
  - IP
  - ICMP
  - ARP (Link Layer와 연계)
- TCP/UDP는 Transport Layer에서 동작하지만, IP 위에서 동작합니다.

---

## IP 주소 개념

- IP 주소는 네트워크 상에서 host를 구분하는 고유한 주소입니다.
- 인터넷에서 사용되는 IP는 유일해야 합니다.
- IPv4는 32bit로 구성됩니다.

예시

    00000001 00000001 00000001 00000001 → 1.1.1.1
    00000001 10000001 00000011 00000001 → 1.129.3.1

- IP 주소는 단독으로 존재하지 않으며 다음 3가지가 함께 설정되어야 합니다.
  - IP Address: 네트워크에서 장치를 식별하기 위한 고유한 논리적 주소
  - Netmask (Subnet Mask):  IP 주소에서 네트워크 영역과 호스트 영역을 구분하는 기준
  - Gateway: 다른 네트워크로 나갈 때 반드시 거쳐야 하는 출입구 역할의 장치

---

## Class 기반 IP 주소 체계

- Class는 현재 기술적 스펙이 아닌 과거 관리 체계입니다.
- IP 낭비 문제로 인해 Class 기반 할당은 실패하였습니다.
- 현재는 CIDR 기반 주소 체계를 사용합니다.

### Class 요약

- A Class  
  - 범위: 0 ~ 127  
  - Netmask: 255.0.0.0  
  - 예: 110.0.0.0 ~ 110.255.255.255  

- B Class  
  - 범위: 128 ~ 191  
  - Netmask: 255.255.0.0  
  - 예: 180.10.0.0 ~ 180.10.255.255  

- C Class  
  - 범위: 192 ~ 223  
  - Netmask: 255.255.255.0  
  - 예: 203.12.34.0 ~ 203.12.34.255  

- D Class  
  - 224 ~ 239 (Multicast)

---

## IP 주소 구조와 Netmask

- IP 주소는 sequence number가 아니라 address 개념입니다.
- Netmask는 IP 주소에서 Network 영역과 Host 영역을 구분해주는 정보입니다.
- IP는 숫자로만 구성되기 때문에 Netmask 없이는 네트워크 범위를 구분할 수 없습니다.

### 개념적 비유
- Network ID -> 동네 주소
- Host ID -> 집 주소

---

## Network ID

- Network ID는 IP 주소와 Netmask를 AND 연산하여 계산합니다.
- 동일한 Network ID를 가진 IP는 같은 네트워크에 속합니다.

- `예시`
```text
    IP: 1.1.1.1
    Netmask: 255.255.255.0

    Network ID: 1.1.1.0
    Broadcast: 1.1.1.255
```
- 1.1.1.0 ~ 1.1.1.255 범위의 host끼리는 직접 통신 가능합니다.
- 다른 네트워크와의 통신은 Gateway를 통해 이루어집니다.

---

## Network ID 계산 예시

- `예시`
```text
    IP: 203.248.224.12
    Netmask: 255.255.255.0

    AND 연산 결과
    -> 203.248.224.0
```
- Network 범위: 203.248.224.0 ~ 203.248.224.255


---

## Network ID와 Broadcast 주소

- 네트워크 내에서 다음 두 주소는 사용할 수 없습니다.
  - Network ID (첫 번째 주소)
  - Broadcast Address (마지막 주소)

- `예시`
```text
    1.1.1.0   -> Network ID
    1.1.1.255 -> Broadcast
```
- CIDR 표기법
  - 1.1.1.2/255.255.255.0 = 1.1.1.2/24
  - 1.1.2.3/255.255.0.0   = 1.1.2.3/16

---

## Gateway

- Host는 동일 네트워크 내 host와만 직접 통신할 수 있습니다.
- 다른 네트워크와의 통신은 Gateway가 대신 수행합니다.
- Gateway 역할은 라우터 또는 공유기가 담당합니다.
- Default Gateway는 반드시 1개만 설정 가능합니다.

### 인터넷 사용을 위한 필수 3요소
- IP
- Netmask
- Gateway

---

## Bogon IP (특수 목적 IP)

- 인터넷에서 사용하면 안 되는 특수 목적 IP 대역입니다.

### 주요 Bogon IP

- 0.0.0.0  
  - Any address

- 127.0.0.0 ~ 127.255.255.255  
  - Loopback

- 169.254.0.0 ~ 169.254.255.255  
  - Zero Configuration (DHCP 실패 시 자동 설정)

- 255.255.255.255  
  - Local Broadcast

### 사설 IP 대역

- 10.0.0.0 ~ 10.255.255.255
- 172.16.0.0 ~ 172.31.255.255
- 192.168.0.0 ~ 192.168.255.255

---

## 네트워크 분할 (Subnetting)

- Netmask는 네트워크 범위를 결정합니다.
- Bitmasking을 통해 하나의 네트워크를 여러 개로 분할할 수 있습니다.

`예시`

- 1.1.1.0/24
- Netmask: 255.255.255.128

`결과`
- 1.1.1.0/25
- 1.1.1.128/25

---

## VLSM (Variable Length Subnet Mask)

- 서로 다른 크기의 네트워크로 분할하는 방식입니다.
- IP 낭비를 줄이기 위해 사용됩니다.
- Class 기반 라우팅 프로토콜에서는 사용 불가합니다.
  - RIP
  - IGRP

---

## NAT (Network Address Translation)

- 공인 IP 부족 문제를 해결하기 위해 사용됩니다.
- 사설 IP를 공인 IP로 변환합니다.
- 외부에서 내부 네트워크 직접 접근을 차단하는 효과가 있습니다.
- 현재는 방화벽 기능의 일부로 인식됩니다.

### NAT 특징
- 1:N 방식이 일반적
- 공유기, 방화벽에서 제공
- 성능 저하는 현대 환경에서 거의 없음

---

## ICMP

- 네트워크 오류 보고 및 상태 확인을 위한 프로토콜입니다.
- IP의 비신뢰성을 보완합니다.

### 대표 명령어
- ping
- traceroute (tracert)

- 보안상 이유로 방화벽에서 차단되는 경우가 많습니다.

---

## ARP

- IP 주소를 이용해 MAC 주소를 알아내는 프로토콜입니다.
- 논리 주소(IP)를 물리 주소(MAC)로 변환합니다.
- 브로드캐스트 요청(Request), 유니캐스트 응답(Reply) 구조입니다.
- 보안 기능이 없어 ARP Spoofing 공격에 취약합니다.

---

# 라우팅 과정 개념 설명 (Client -> Router -> Server)

![routing](/Concept/imgs/routing.png)

## 개요

- 이 그림은 **클라이언트가 서버로 통신할 때 라우터를 거치며 패킷과 프레임이 어떻게 변하는지**를 설명하는 그림입니다.
- 핵심 포인트는 **IP 주소는 유지되고, Frame의 MAC 주소만 홉(hop)마다 바뀐다**는 점입니다.

---

## 전체 통신 흐름 요약

1. Client가 Server로 데이터를 보내려고 함
2. Client는 **다음 홉인 라우터(R1)의 MAC 주소**를 목적지로 프레임을 생성
3. 라우터는 프레임을 벗기고(IP 기준 판단), 다시 새로운 프레임으로 재포장
4. Server가 있는 네트워크 쪽으로 전달
5. Server는 자신의 IP/포트(80)로 들어온 요청을 처리

---

## Client 측에서의 상태

- Source IP: `1.1.1.3`
- Destination IP: `2.2.2.11`
- Source Port: `4091`
- Destination Port: `80`

Client 입장에서는 **서버의 IP(2.2.2.11)를 목적지로 알고 있음**  
하지만 **프레임의 목적지 MAC은 서버가 아니라 라우터(R1)** 입니다.

---

## 첫 번째 프레임 (Client -> Router)

### Frame 구성

- D (Destination MAC): **R1**
- C (Source MAC): **Client**
- Payload: IP 패킷 (1.1.1.3 → 2.2.2.11)

### 이유  
- Client는 서버가 같은 네트워크에 없다는 것을 알고 있음  
- 따라서 **Gateway(R1)로 프레임을 전송**

---

## 라우터에서의 처리

### 라우팅 테이블 정보
- 라우팅 테이블은 **목적지 IP 대역에 따라 어떤 인터페이스(또는 다음 홉)로 패킷을 보낼지 결정하는 기준표**입니다.

### 그림 속 라우팅 테이블 의미

| 목적지 네트워크 | 출력 인터페이스 |
|----------------|----------------|
| 1.1.1.0/24     | R1 인터페이스 |
| 2.2.2.0/24     | R2 인터페이스 |

- `1.1.1.0/24` : 클라이언트가 속한 네트워크  
- `2.2.2.0/24` : 서버가 속한 네트워크  

#### 라우터는 패킷의 **Destination IP**를 확인한 뒤,
- 목적지가 `2.2.2.11` 이므로  
- `2.2.2.0/24` 항목과 매칭
- 해당 엔트리에 지정된 **R2 인터페이스**로 패킷을 전달합니다.

### 핵심 포인트

- 라우팅 테이블은 **IP 기준**으로 동작한다
- MAC 주소는 라우팅 판단에 사용되지 않는다


- 1.1.1.1 -> R1
- 2.2.2.1 -> R2

### 라우터 동작 순서

1. 프레임 수신
2. 프레임 제거 (MAC 주소는 여기서 의미 없음)
3. IP 헤더 확인
4. 라우팅 테이블 조회
5. 다음 홉(R2 인터페이스) 결정
6. **새로운 프레임 생성**

---

## 두 번째 프레임 (Router -> Server)

### Frame 구성

- D (Destination MAC): **S (Server)**
- R2 (Source MAC): **Router 인터페이스**
- Payload: **동일한 IP 패킷**

## 핵심  
- **IP 주소는 변하지 않음**
- **Frame(MAC 주소)만 새로 생성됨**

---

## Server 측에서의 상태

- Destination IP: `2.2.2.11`
- Destination Port: `80`

### Server는 다음만 확인함

- IP가 자기 자신인가?
- 포트가 열려 있는가?

-> 정상이면 애플리케이션(웹 서버)이 요청을 처리함

---

## 라우팅 과정 정리

- 라우팅은 **IP 기준**으로 이루어진다
- Frame(MAC 주소)은 **홉마다 변경**
- IP 주소는 **출발지 -> 목적지까지 유지**
- 라우터는 **프레임을 전달하지 않고 재생성**한다

---

## 정리

- IP는 네트워크 상 host를 식별하는 주소입니다.
- Netmask는 네트워크 범위를 결정합니다.
- Gateway는 다른 네트워크로 나가는 출입구입니다.
- Network ID 계산은 AND 연산으로 수행됩니다.
- Subnetting과 VLSM은 IP 자원을 효율적으로 사용하기 위한 기술입니다.
